{
    # Global options
    email your-email@example.com
    
    # Server timeouts for all sites
    servers {
        timeouts {
            read_body   30s
            read_header 10s
            write       30s
            idle        2m
        }
    }
}

localhost {
    # Request body size limit (matches backend limit)
    request_body {
        max_size 1MB
    }

    # Route /api/* requests to the Go Backend
    handle /api/* {
        uri strip_prefix /api
        reverse_proxy backend:8080 {
            # Connection settings
            transport http {
                dial_timeout 5s
                response_header_timeout 30s
            }
            
            # Health checking
            health_uri /health
            health_interval 30s
            health_timeout 5s
            
            # Pass client IP to backend
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
        }
    }

    # Route all other traffic to the Frontend
    handle /* {
        reverse_proxy frontend:3000 {
            transport http {
                dial_timeout 5s
                response_header_timeout 30s
            }
            
            health_uri /
            health_interval 30s
            health_timeout 5s
        }

        # Cache static assets (Next.js serves these with hashed filenames)
        @static {
            path *.js *.css *.png *.jpg *.jpeg *.webp *.svg *.woff *.woff2 *.ico *.gif
        }
        header @static Cache-Control "public, max-age=31536000, immutable"
        
        # Cache Next.js static directory
        @nextStatic {
            path /_next/static/*
        }
        header @nextStatic Cache-Control "public, max-age=31536000, immutable"
    }

    # Compression (zstd preferred, gzip fallback)
    encode zstd gzip

    # Security Headers
    header {
        # Prevent MIME type sniffing
        X-Content-Type-Options "nosniff"
        
        # Prevent clickjacking
        X-Frame-Options "DENY"
        
        # XSS protection (legacy but still useful)
        X-XSS-Protection "1; mode=block"
        
        # Force HTTPS
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        
        # Control referrer information
        Referrer-Policy "strict-origin-when-cross-origin"
        
        # Restrict browser features
        Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
        
        # Content Security Policy
        # - self: allow resources from same origin
        # - unsafe-inline: needed for Next.js inline styles/scripts
        # - unsafe-eval: needed for Next.js development (remove in strict production)
        # - images.unsplash.com: external images used in portfolio
        # - fonts.gstatic.com & fonts.googleapis.com: Google Fonts
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://images.unsplash.com; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'"
        
        # Remove server identification
        -Server
    }

    # Basic logging
    log {
        output stdout
        format json
    }
}
